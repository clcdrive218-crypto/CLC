<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLC Treasurer Dashboard - GitHub Storage</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(to right, #2c3e50, #4a6491);
            color: white;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            padding: 25px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        .card-header i {
            font-size: 1.8rem;
            margin-right: 15px;
            color: #4a6491;
        }
        
        .card-title {
            font-size: 1.5rem;
            color: #2c3e50;
        }
        
        .balance-display {
            text-align: center;
            padding: 20px;
        }
        
        .balance-amount {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 10px 0;
        }
        
        .balance-label {
            font-size: 1.1rem;
            color: #7f8c8d;
        }
        
        .total-balance {
            background: linear-gradient(to right, #3498db, #2c3e50);
            color: white;
        }
        
        .total-balance .balance-amount {
            color: white;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        button {
            background: linear-gradient(to right, #3498db, #2c3e50);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: linear-gradient(to right, #2ecc71, #27ae60);
        }
        
        .btn-danger {
            background: linear-gradient(to right, #e74c3c, #c0392b);
        }
        
        .btn-github {
            background: linear-gradient(to right, #333, #666);
        }
        
        .programs-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .programs-table th, .programs-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .programs-table th {
            background-color: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .programs-table tr:hover {
            background-color: #f1f7fd;
        }
        
        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 6px;
            padding: 25px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            background-color: #f1f7fd;
            border-color: #2c3e50;
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-name {
            margin-top: 10px;
            font-style: italic;
            color: #7f8c8d;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #eee;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .expenses-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .expense-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .expense-item:last-child {
            border-bottom: none;
        }
        
        .expense-details {
            flex-grow: 1;
        }
        
        .expense-amount {
            font-weight: 700;
            color: #e74c3c;
        }
        
        .proof-link {
            color: #3498db;
            text-decoration: none;
            margin-left: 10px;
        }
        
        .proof-link:hover {
            text-decoration: underline;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-top: 30px;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 5px;
        }
        
        .delete-btn:hover {
            background: rgba(231, 76, 60, 0.1);
            border-radius: 4px;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-active {
            background-color: #e8f7ef;
            color: #27ae60;
        }
        
        .status-over-budget {
            background-color: #fdeded;
            color: #e74c3c;
        }
        
        .status-warning {
            background-color: #fef9e7;
            color: #f39c12;
        }
        
        .status-completed {
            background-color: #eaf2f8;
            color: #3498db;
        }
        
        .mark-complete-btn {
            background: none;
            border: none;
            color: #27ae60;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 5px;
        }
        
        .mark-complete-btn:hover {
            background: rgba(46, 204, 113, 0.1);
            border-radius: 4px;
        }
        
        .description-points {
            padding-left: 20px;
            margin-top: 10px;
        }
        
        .description-points li {
            margin-bottom: 5px;
        }
        
        .program-details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .program-details h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            background: #27ae60;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(200%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background: #e8f4f8;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .sync-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #27ae60;
        }
        
        .sync-indicator.syncing {
            background: #f39c12;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        
        .github-info {
            background: #f0f0f0;
            border-left: 4px solid #333;
            padding: 15px;
            border-radius: 0 6px 6px 0;
            margin: 20px 0;
        }
        
        .auth-section {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .auth-section h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .auth-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .setup-steps {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .setup-steps ol {
            padding-left: 20px;
        }
        
        .setup-steps li {
            margin-bottom: 15px;
        }
        
        .token-input {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .token-input input {
            flex-grow: 1;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .programs-table {
                display: block;
                overflow-x: auto;
            }
            
            .auth-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-church"></i> CLC Treasurer Dashboard</h1>
            <p class="subtitle">GitHub Gist Storage Edition</p>
        </header>
        
        <div class="auth-section" id="auth-section">
            <h2><i class="fab fa-github"></i> GitHub Authorization Required</h2>
            <p>To securely store your financial data, please authorize with your GitHub account.</p>
            <p>Your data will be stored in private GitHub Gists.</p>
            
            <div class="setup-steps">
                <h3>Setup Instructions:</h3>
                <ol>
                    <li>Create a GitHub personal access token with "gist" permissions</li>
                    <li>Enter your token below</li>
                    <li>Optionally enter an existing Gist ID to load previous data</li>
                </ol>
                
                <div class="token-input">
                    <input type="password" id="github-token" placeholder="Enter GitHub Token">
                    <button id="save-token-btn"><i class="fas fa-save"></i> Save</button>
                </div>
                
                <div class="token-input" style="margin-top: 10px;">
                    <input type="text" id="gist-id" placeholder="Enter Gist ID (optional)">
                    <button id="load-gist-btn"><i class="fas fa-download"></i> Load Data</button>
                </div>
            </div>
            
            <div class="auth-buttons">
                <button id="demo-mode-btn">
                    <i class="fas fa-desktop"></i> Demo Mode (No Auth)
                </button>
            </div>
        </div>
        
        <div id="app-content" style="display: none;">
            <div class="sync-status">
                <div class="sync-indicator" id="sync-indicator"></div>
                <span id="sync-status">Ready to sync with GitHub</span>
                <button id="manual-sync-btn" class="btn-github">
                    <i class="fas fa-sync"></i> Sync Now
                </button>
            </div>
            
            <div class="github-info">
                <p><i class="fas fa-info-circle"></i> All data is stored in your GitHub Gists. No local browser storage is used.</p>
                <p>Gist ID: <strong id="current-gist-id">Not yet created</strong></p>
            </div>
            
            <div class="dashboard">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-university"></i>
                        <h2 class="card-title">Bank Balance</h2>
                    </div>
                    <div class="balance-display">
                        <div class="balance-label">Current Bank Funds</div>
                        <div class="balance-amount" id="bank-balance">$60,000.00</div>
                        <p>Last Updated: <span id="bank-update-time">Never</span></p>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-money-bill-wave"></i>
                        <h2 class="card-title">Cash on Hand</h2>
                    </div>
                    <div class="balance-display">
                        <div class="balance-label">Physical Cash Available</div>
                        <div class="balance-amount" id="cash-balance">$10,000.00</div>
                        <p>Last Counted: <span id="cash-update-time">Never</span></p>
                    </div>
                </div>
                
                <div class="card total-balance">
                    <div class="card-header">
                        <i class="fas fa-calculator"></i>
                        <h2 class="card-title">Total Funds</h2>
                    </div>
                    <div class="balance-display">
                        <div class="balance-label">Combined Resources</div>
                        <div class="balance-amount" id="total-balance">$70,000.00</div>
                        <p>All Accounts Combined</p>
                    </div>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="program">Program Budgeting</div>
                <div class="tab" data-tab="expenses">Expense Tracking</div>
                <div class="tab" data-tab="reports">Financial Reports</div>
            </div>
            
            <div class="tab-content active" id="program-tab">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-calendar-plus"></i>
                        <h2 class="card-title">Create New Program Budget</h2>
                    </div>
                    
                    <form id="program-form">
                        <div class="form-group">
                            <label for="program-name">Program Name</label>
                            <input type="text" id="program-name" placeholder="Enter program name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="program-date">Date & Time</label>
                            <input type="datetime-local" id="program-date" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="budget-amount">Budget Amount ($)</label>
                            <input type="number" id="budget-amount" placeholder="Enter budget amount" min="0" step="0.01" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="program-description">Description (Use bullet points for items)</label>
                            <textarea id="program-description" placeholder="Example:&#10;&#8226; Buy glue&#10;&#8226; Purchase flex sheets&#10;&#8226; Iron rods for structure"></textarea>
                        </div>
                        
                        <button type="submit"><i class="fas fa-plus-circle"></i> Create Program Budget</button>
                    </form>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-list"></i>
                        <h2 class="card-title">Active Programs</h2>
                    </div>
                    
                    <table class="programs-table" id="programs-table">
                        <thead>
                            <tr>
                                <th>Program</th>
                                <th>Date & Time</th>
                                <th>Budget</th>
                                <th>Spent</th>
                                <th>Remaining</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="programs-tbody">
                            <!-- Programs will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="expenses-tab">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-receipt"></i>
                        <h2 class="card-title">Record New Expense</h2>
                    </div>
                    
                    <form id="expense-form">
                        <div class="form-group">
                            <label for="program-select">Select Program</label>
                            <select id="program-select" required>
                                <option value="">-- Select a Program --</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="expense-amount">Expense Amount ($)</label>
                            <input type="number" id="expense-amount" placeholder="Enter expense amount" min="0" step="0.01" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="expense-category">Category</label>
                            <select id="expense-category" required>
                                <option value="">-- Select Category --</option>
                                <option value="supplies">Supplies & Materials</option>
                                <option value="venue">Venue/Rental</option>
                                <option value="food">Food & Catering</option>
                                <option value="transportation">Transportation</option>
                                <option value="speakers">Speaker Fees</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="expense-description">Description</label>
                            <textarea id="expense-description" rows="2" placeholder="Brief description of the expense"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Upload Receipt/Bill</label>
                            <div class="upload-area" id="upload-area">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <p>Click to upload receipt or drag and drop</p>
                                <p class="small">(PDF, JPG, PNG up to 5MB)</p>
                                <input type="file" id="bill-upload" class="file-input" accept=".pdf,.jpg,.jpeg,.png">
                                <div class="file-name" id="file-name">No file selected</div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn-secondary"><i class="fas fa-save"></i> Record Expense</button>
                    </form>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <h2 class="card-title">Recent Expenses</h2>
                    </div>
                    
                    <div class="expenses-list" id="expenses-list">
                        <!-- Expenses will be added here dynamically -->
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="reports-tab">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-line"></i>
                        <h2 class="card-title">Financial Overview</h2>
                    </div>
                    
                    <div style="height: 300px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px;">
                        <p style="color: #7f8c8d; text-align: center;">
                            <i class="fas fa-chart-pie" style="font-size: 3rem; margin-bottom: 15px;"></i><br>
                            Financial reports visualization will appear here<br>
                            <small>Monthly income/expense trends and program spending analysis</small>
                        </p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-around; margin-top: 30px; flex-wrap: wrap; gap: 15px;">
                        <button class="btn-secondary" id="export-btn">
                            <i class="fas fa-file-export"></i> Export Data
                        </button>
                        <button id="save-to-gist-btn" class="btn-github">
                            <i class="fab fa-github"></i> Save to GitHub Gist
                        </button>
                        <button>
                            <i class="fas fa-envelope"></i> Email to Leadership
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="notification" id="notification">
            <i class="fas fa-check-circle"></i> <span id="notification-text">Notification message</span>
        </div>
        
        <footer>
            <p>Christ Life Community (CLC) Treasurer Dashboard | "Each of you should give what you have decided in your heart to give, not reluctantly or under compulsion, for God loves a cheerful giver." - 2 Corinthians 9:7</p>
            <p>© 2023 CLC Financial Ministry. All rights reserved.</p>
        </footer>
    </div>

    <script>
        // Global state
        let bankBalance = 60000;
        let cashBalance = 10000;
        let totalBalance = bankBalance + cashBalance;
        let programs = [];
        let expenses = [];
        let githubToken = '';
        let gistId = '';
        let isAuthenticated = false;
        let lastSyncTime = null;
        
        // DOM Elements
        const authSection = document.getElementById('auth-section');
        const appContent = document.getElementById('app-content');
        const bankBalanceEl = document.getElementById('bank-balance');
        const cashBalanceEl = document.getElementById('cash-balance');
        const totalBalanceEl = document.getElementById('total-balance');
        const programForm = document.getElementById('program-form');
        const expenseForm = document.getElementById('expense-form');
        const programsTableBody = document.getElementById('programs-tbody');
        const programSelect = document.getElementById('program-select');
        const expensesList = document.getElementById('expenses-list');
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('bill-upload');
        const fileNameDisplay = document.getElementById('file-name');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');
        const syncIndicator = document.getElementById('sync-indicator');
        const syncStatus = document.getElementById('sync-status');
        const saveToGistBtn = document.getElementById('save-to-gist-btn');
        const exportBtn = document.getElementById('export-btn');
        const demoModeBtn = document.getElementById('demo-mode-btn');
        const githubTokenInput = document.getElementById('github-token');
        const gistIdInput = document.getElementById('gist-id');
        const saveTokenBtn = document.getElementById('save-token-btn');
        const loadGistBtn = document.getElementById('load-gist-btn');
        const currentGistIdEl = document.getElementById('current-gist-id');
        const manualSyncBtn = document.getElementById('manual-sync-btn');
        const bankUpdateTime = document.getElementById('bank-update-time');
        const cashUpdateTime = document.getElementById('cash-update-time');
        
        // Format currency
        function formatCurrency(amount) {
            return '$' + amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }
        
        // Show notification
        function showNotification(message, isError = false) {
            notificationText.textContent = message;
            notification.style.background = isError ? '#e74c3c' : '#27ae60';
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Update sync status
        function updateSyncStatus() {
            if (lastSyncTime) {
                syncIndicator.className = 'sync-indicator';
                syncStatus.textContent = `Last synced: ${new Date(lastSyncTime).toLocaleTimeString()}`;
            } else {
                syncIndicator.className = 'sync-indicator syncing';
                syncStatus.textContent = 'Ready to sync with GitHub';
            }
        }
        
        // Update timestamps
        function updateTimestamps() {
            const now = new Date().toLocaleString();
            bankUpdateTime.textContent = now;
            cashUpdateTime.textContent = now;
        }
        
        // Update balance displays
        function updateBalances() {
            bankBalanceEl.textContent = formatCurrency(bankBalance);
            cashBalanceEl.textContent = formatCurrency(cashBalance);
            totalBalanceEl.textContent = formatCurrency(totalBalance);
            updateTimestamps();
        }
        
        // Save data to GitHub Gist
        async function saveToGist() {
            if (!githubToken) {
                showNotification('Please enter your GitHub token first!', true);
                return;
            }
            
            syncIndicator.className = 'sync-indicator syncing';
            syncStatus.textContent = 'Saving to GitHub...';
            
            const data = {
                bankBalance,
                cashBalance,
                totalBalance,
                programs,
                expenses,
                lastSaved: new Date().toISOString()
            };
            
            const filename = `clc_treasurer_data_${new Date().toISOString().slice(0,10)}.json`;
            
            try {
                const gistData = {
                    description: "CLC Treasurer Dashboard Data",
                    public: false,
                    files: {}
                };
                
                if (gistId) {
                    // Update existing gist
                    gistData.files[filename] = {
                        content: JSON.stringify(data, null, 2)
                    };
                    
                    const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(gistData)
                    });
                    
                    if (!response.ok) throw new Error('Failed to update gist');
                } else {
                    // Create new gist
                    gistData.files[filename] = {
                        content: JSON.stringify(data, null, 2)
                    };
                    
                    const response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(gistData)
                    });
                    
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);
                    
                    gistId = result.id;
                    currentGistIdEl.textContent = gistId;
                }
                
                lastSyncTime = new Date();
                updateSyncStatus();
                showNotification('Data saved to GitHub Gist!');
                
                return true;
            } catch (error) {
                console.error('Save error:', error);
                syncIndicator.className = 'sync-indicator';
                syncStatus.textContent = 'Sync failed';
                showNotification(`Save failed: ${error.message}`, true);
                return false;
            }
        }
        
        // Load data from GitHub Gist
        async function loadFromGist(id) {
            if (!githubToken) {
                showNotification('Please enter your GitHub token first!', true);
                return;
            }
            
            const targetGistId = id || gistId;
            if (!targetGistId) {
                showNotification('Please enter a Gist ID to load data', true);
                return;
            }
            
            syncIndicator.className = 'sync-indicator syncing';
            syncStatus.textContent = 'Loading from GitHub...';
            
            try {
                const response = await fetch(`https://api.github.com/gists/${targetGistId}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load gist');
                }
                
                const gist = await response.json();
                
                // Find the first JSON file
                let jsonData = null;
                for (const filename in gist.files) {
                    if (filename.endsWith('.json')) {
                        jsonData = JSON.parse(gist.files[filename].content);
                        break;
                    }
                }
                
                if (!jsonData) {
                    throw new Error('No JSON data found in gist');
                }
                
                // Update global state
                bankBalance = jsonData.bankBalance || 60000;
                cashBalance = jsonData.cashBalance || 10000;
                totalBalance = jsonData.totalBalance || 70000;
                programs = jsonData.programs || [];
                expenses = jsonData.expenses || [];
                lastSyncTime = jsonData.lastSaved ? new Date(jsonData.lastSaved) : new Date();
                
                // Update UI
                updateBalances();
                renderPrograms();
                renderExpenses();
                gistId = targetGistId;
                currentGistIdEl.textContent = gistId;
                updateSyncStatus();
                
                showNotification('Data loaded from GitHub Gist!');
                return true;
            } catch (error) {
                console.error('Load error:', error);
                syncIndicator.className = 'sync-indicator';
                syncStatus.textContent = 'Sync failed';
                showNotification(`Load failed: ${error.message}`, true);
                return false;
            }
        }
        
        // Render programs table
        function renderPrograms() {
            programsTableBody.innerHTML = '';
            programSelect.innerHTML = '<option value="">-- Select a Program --</option>';
            
            programs.forEach((program, index) => {
                // Calculate remaining budget
                const spent = program.expenses.reduce((sum, exp) => sum + exp.amount, 0);
                const remaining = program.budget - spent;
                
                // Determine status
                let statusClass = 'status-active';
                let statusText = 'Active';
                if (program.completed) {
                    statusClass = 'status-completed';
                    statusText = 'Completed';
                } else if (remaining < 0) {
                    statusClass = 'status-over-budget';
                    statusText = 'Over Budget';
                } else if (remaining < program.budget * 0.2) {
                    statusClass = 'status-warning';
                    statusText = 'Warning';
                }
                
                // Parse description into bullet points
                const descriptionPoints = program.description.split('\n')
                    .filter(line => line.trim() !== '')
                    .map(line => line.replace(/^\s*[\u2022\-]\s*/, '').trim());
                
                // Add to programs table
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div><strong>${program.name}</strong></div>
                        ${descriptionPoints.length > 0 ? `
                        <div class="program-details">
                            <h4>Description Items:</h4>
                            <ul class="description-points">
                                ${descriptionPoints.map(point => `<li>${point}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                    </td>
                    <td>${new Date(program.date).toLocaleString()}</td>
                    <td>${formatCurrency(program.budget)}</td>
                    <td>${formatCurrency(spent)}</td>
                    <td>${formatCurrency(remaining)}</td>
                    <td><span class="status-indicator ${statusClass}">${statusText}</span></td>
                    <td>
                        ${program.completed ? '' : `<button class="mark-complete-btn" data-index="${index}"><i class="fas fa-check"></i></button>`}
                        <button class="delete-btn" data-index="${index}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                programsTableBody.appendChild(row);
                
                // Add to expense form dropdown only if not completed
                if (!program.completed) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = program.name;
                    programSelect.appendChild(option);
                }
            });
            
            // Add event listeners to mark complete buttons
            document.querySelectorAll('.mark-complete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    markProgramComplete(index);
                });
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteProgram(index);
                });
            });
        }
        
        // Render expenses list
        function renderExpenses() {
            expensesList.innerHTML = '';
            
            // Sort expenses by date (newest first)
            const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedExpenses.forEach(expense => {
                const program = programs.find(p => p.id === expense.programId);
                const programName = program ? program.name : 'Unknown Program';
                
                const expenseItem = document.createElement('div');
                expenseItem.className = 'expense-item';
                expenseItem.innerHTML = `
                    <div class="expense-details">
                        <div><strong>${expense.description || 'Unnamed Expense'}</strong></div>
                        <div>${expense.category} • ${programName} • ${new Date(expense.date).toLocaleDateString()}</div>
                    </div>
                    <div class="expense-amount">${formatCurrency(expense.amount)}</div>
                    <div><a href="#" class="proof-link">View Bill</a></div>
                `;
                expensesList.appendChild(expenseItem);
            });
        }
        
        // Mark a program as complete
        function markProgramComplete(index) {
            if (confirm('Mark this program as completed?\nUnused budget will be returned to cash on hand.')) {
                const program = programs[index];
                const spent = program.expenses.reduce((sum, exp) => sum + exp.amount, 0);
                const remaining = program.budget - spent;
                
                // Return unused budget to cash on hand
                if (remaining > 0) {
                    cashBalance += remaining;
                    totalBalance = bankBalance + cashBalance;
                    updateBalances();
                    
                    showNotification(`$${remaining.toFixed(2)} returned to cash on hand from "${program.name}"`);
                }
                
                program.completed = true;
                renderPrograms();
                showNotification(`Program "${program.name}" marked as completed!`);
                
                // Auto-save to GitHub
                saveToGist();
            }
        }
        
        // Delete a program
        function deleteProgram(index) {
            if (confirm('Are you sure you want to delete this program? All associated expenses will also be deleted.')) {
                const program = programs[index];
                
                // Return full budget to cash on hand when deleting
                cashBalance += program.budget;
                totalBalance = bankBalance + cashBalance;
                updateBalances();
                
                // Remove program and its expenses
                const programId = program.id;
                programs.splice(index, 1);
                expenses = expenses.filter(expense => expense.programId !== programId);
                
                // Re-render
                renderPrograms();
                renderExpenses();
                
                showNotification(`Program "${program.name}" deleted and budget returned!`);
                
                // Auto-save to GitHub
                saveToGist();
            }
        }
        
        // Handle program form submission
        programForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('program-name').value;
            const date = document.getElementById('program-date').value;
            const budget = parseFloat(document.getElementById('budget-amount').value);
            const description = document.getElementById('program-description').value;
            
            // Deduct budget from cash balance
            if (budget > cashBalance) {
                alert('Insufficient cash funds for this program budget!');
                return;
            }
            
            cashBalance -= budget;
            totalBalance = bankBalance + cashBalance;
            updateBalances();
            
            // Create program object
            const program = {
                id: Date.now(), // Unique ID
                name,
                date,
                budget,
                description,
                expenses: [],
                completed: false
            };
            
            programs.push(program);
            
            // Re-render programs
            renderPrograms();
            
            // Reset form
            programForm.reset();
            
            // Set current date/time
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('program-date').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            showNotification(`Program "${name}" created with $${budget.toFixed(2)} budget!`);
            
            // Auto-save to GitHub
            saveToGist();
        });
        
        // Handle expense form submission
        expenseForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const programIndex = parseInt(document.getElementById('program-select').value);
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const category = document.getElementById('expense-category').value;
            const description = document.getElementById('expense-description').value;
            
            if (isNaN(programIndex)) {
                alert('Please select a program');
                return;
            }
            
            const program = programs[programIndex];
            
            // Add expense to program
            const expense = {
                id: Date.now(),
                programId: program.id,
                amount,
                category,
                description,
                date: new Date().toISOString()
            };
            
            program.expenses.push(expense);
            expenses.push(expense);
            
            // Re-render
            renderPrograms();
            renderExpenses();
            
            // Reset form
            expenseForm.reset();
            fileNameDisplay.textContent = 'No file selected';
            
            showNotification(`Expense of $${amount.toFixed(2)} recorded for "${program.name}"!`);
            
            // Auto-save to GitHub
            saveToGist();
        });
        
        // File upload handling
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
            } else {
                fileNameDisplay.textContent = 'No file selected';
            }
        });
        
        // Tab switching functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and content
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Show corresponding content
                const tabId = tab.getAttribute('data-tab') + '-tab';
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // Export data to JSON
        exportBtn.addEventListener('click', () => {
            const dataStr = JSON.stringify({
                bankBalance,
                cashBalance,
                totalBalance,
                programs,
                expenses,
                exportedAt: new Date().toISOString()
            }, null, 2);
            
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `clc_treasurer_data_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Data exported successfully!');
        });
        
        // Save to GitHub Gist
        saveToGistBtn.addEventListener('click', saveToGist);
        
        // Manual sync
        manualSyncBtn.addEventListener('click', saveToGist);
        
        // Save GitHub token
        saveTokenBtn.addEventListener('click', () => {
            githubToken = githubTokenInput.value.trim();
            if (githubToken) {
                showNotification('GitHub token saved!');
            } else {
                showNotification('Please enter a valid token', true);
            }
        });
        
        // Load from Gist
        loadGistBtn.addEventListener('click', () => {
            const id = gistIdInput.value.trim();
            if (id) {
                loadFromGist(id);
            } else {
                showNotification('Please enter a Gist ID', true);
            }
        });
        
        // Demo mode
        demoModeBtn.addEventListener('click', () => {
            isAuthenticated = true;
            authSection.style.display = 'none';
            appContent.style.display = 'block';
            showNotification('Demo mode activated - data will not be saved permanently');
        });
        
        // Initialize with current date/time
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const formattedDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
        document.getElementById('program-date').value = formattedDateTime;
        
        // Update sync status
        updateSyncStatus();
        
        // Sample program for demonstration
        setTimeout(() => {
            if (programs.length === 0) {
                programs.push({
                    id: Date.now() - 1000,
                    name: "Christmas Star Project",
                    date: "2023-12-20T18:00",
                    budget: 5000,
                    description: "• Buy glue\n• Purchase flex sheets\n• Iron rods for structure\n• LED lights\n• Mounting hardware",
                    expenses: [
                        { id: 1, programId: Date.now() - 1000, amount: 1200, category: "supplies", description: "Flex sheets", date: "2023-12-01T10:00:00Z" },
                        { id: 2, programId: Date.now() - 1000, amount: 800, category: "supplies", description: "Iron rods", date: "2023-12-02T14:30:00Z" },
                        { id: 3, programId: Date.now() - 1000, amount: 500, category: "supplies", description: "LED lights", date: "2023-12-03T09:15:00Z" }
                    ],
                    completed: false
                });
                
                expenses.push(
                    { id: 1, programId: Date.now() - 1000, amount: 1200, category: "supplies", description: "Flex sheets", date: "2023-12-01T10:00:00Z" },
                    { id: 2, programId: Date.now() - 1000, amount: 800, category: "supplies", description: "Iron rods", date: "2023-12-02T14:30:00Z" },
                    { id: 3, programId: Date.now() - 1000, amount: 500, category: "supplies", description: "LED lights", date: "2023-12-03T09:15:00Z" }
                );
                
                renderPrograms();
                renderExpenses();
            }
        }, 500);
    </script>
</body>
</html>