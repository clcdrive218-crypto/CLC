<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLC Treasurer Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(to right, #2c3e50, #4a6491);
            color: white;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            padding: 25px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        .card-header i {
            font-size: 1.8rem;
            margin-right: 15px;
            color: #4a6491;
        }
        
        .card-title {
            font-size: 1.5rem;
            color: #2c3e50;
        }
        
        .balance-display {
            text-align: center;
            padding: 20px;
        }
        
        .balance-amount {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 10px 0;
        }
        
        .balance-label {
            font-size: 1.1rem;
            color: #7f8c8d;
        }
        
        .total-balance {
            background: linear-gradient(to right, #3498db, #2c3e50);
            color: white;
        }
        
        .total-balance .balance-amount {
            color: white;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        button {
            background: linear-gradient(to right, #3498db, #2c3e50);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: linear-gradient(to right, #2ecc71, #27ae60);
        }
        
        .btn-danger {
            background: linear-gradient(to right, #e74c3c, #c0392b);
        }
        
        .programs-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .programs-table th, .programs-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .programs-table th {
            background-color: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .programs-table tr:hover {
            background-color: #f1f7fd;
        }
        
        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 6px;
            padding: 25px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            background-color: #f1f7fd;
            border-color: #2c3e50;
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-name {
            margin-top: 10px;
            font-style: italic;
            color: #7f8c8d;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #eee;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .expenses-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .expense-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .expense-item:last-child {
            border-bottom: none;
        }
        
        .expense-details {
            flex-grow: 1;
        }
        
        .expense-amount {
            font-weight: 700;
            color: #e74c3c;
        }
        
        .proof-link {
            color: #3498db;
            text-decoration: none;
            margin-left: 10px;
        }
        
        .proof-link:hover {
            text-decoration: underline;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-top: 30px;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 5px;
        }
        
        .delete-btn:hover {
            background: rgba(231, 76, 60, 0.1);
            border-radius: 4px;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-active {
            background-color: #e8f7ef;
            color: #27ae60;
        }
        
        .status-over-budget {
            background-color: #fdeded;
            color: #e74c3c;
        }
        
        .status-warning {
            background-color: #fef9e7;
            color: #f39c12;
        }
        
        .status-completed {
            background-color: #eaf2f8;
            color: #3498db;
        }
        
        .mark-complete-btn {
            background: none;
            border: none;
            color: #27ae60;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 5px;
        }
        
        .mark-complete-btn:hover {
            background: rgba(46, 204, 113, 0.1);
            border-radius: 4px;
        }
        
        .description-points {
            padding-left: 20px;
            margin-top: 10px;
        }
        
        .description-points li {
            margin-bottom: 5px;
        }
        
        .program-details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .program-details h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            background: #27ae60;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(200%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .cloud-storage-info {
            background: #f0f7ff;
            border-left: 4px solid #3498db;
            padding: 15px;
            border-radius: 0 6px 6px 0;
            margin: 20px 0;
        }
        
        .bill-preview {
            max-width: 80px;
            max-height: 80px;
            margin-top: 10px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .bill-image {
            max-width: 100%;
            max-height: 80vh;
            display: block;
            margin: 0 auto;
        }
        
        .no-bill {
            color: #7f8c8d;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .programs-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-church"></i> CLC Treasurer Dashboard</h1>
            <p class="subtitle">Cloud Storage Edition with Bill Viewer</p>
        </header>
        
        <div class="cloud-storage-info">
            <p><i class="fas fa-info-circle"></i> All data and bill images are stored in the cloud for free. Access from anywhere!</p>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-university"></i>
                    <h2 class="card-title">Bank Balance</h2>
                </div>
                <div class="balance-display">
                    <div class="balance-label">Current Bank Funds</div>
                    <div class="balance-amount" id="bank-balance">$60,000.00</div>
                    <p>Last Updated: <span id="bank-update-time">Today</span></p>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-money-bill-wave"></i>
                    <h2 class="card-title">Cash on Hand</h2>
                </div>
                <div class="balance-display">
                    <div class="balance-label">Physical Cash Available</div>
                    <div class="balance-amount" id="cash-balance">$10,000.00</div>
                    <p>Last Counted: <span id="cash-update-time">This Morning</span></p>
                </div>
            </div>
            
            <div class="card total-balance">
                <div class="card-header">
                    <i class="fas fa-calculator"></i>
                    <h2 class="card-title">Total Funds</h2>
                </div>
                <div class="balance-display">
                    <div class="balance-label">Combined Resources</div>
                    <div class="balance-amount" id="total-balance">$70,000.00</div>
                    <p>All Accounts Combined</p>
                </div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="program">Program Budgeting</div>
            <div class="tab" data-tab="expenses">Expense Tracking</div>
            <div class="tab" data-tab="reports">Financial Reports</div>
        </div>
        
        <div class="tab-content active" id="program-tab">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-calendar-plus"></i>
                    <h2 class="card-title">Create New Program Budget</h2>
                </div>
                
                <form id="program-form">
                    <div class="form-group">
                        <label for="program-name">Program Name</label>
                        <input type="text" id="program-name" placeholder="Enter program name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="program-date">Date & Time</label>
                        <input type="datetime-local" id="program-date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="budget-amount">Budget Amount ($)</label>
                        <input type="number" id="budget-amount" placeholder="Enter budget amount" min="0" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="program-description">Description (Use bullet points for items)</label>
                        <textarea id="program-description" placeholder="Example:&#10;&#8226; Buy glue&#10;&#8226; Purchase flex sheets&#10;&#8226; Iron rods for structure"></textarea>
                    </div>
                    
                    <button type="submit"><i class="fas fa-plus-circle"></i> Create Program Budget</button>
                </form>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-list"></i>
                    <h2 class="card-title">Active Programs</h2>
                </div>
                
                <table class="programs-table" id="programs-table">
                    <thead>
                        <tr>
                            <th>Program</th>
                            <th>Date & Time</th>
                            <th>Budget</th>
                            <th>Spent</th>
                            <th>Remaining</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="programs-tbody">
                        <!-- Programs will be added here dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="expenses-tab">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-receipt"></i>
                    <h2 class="card-title">Record New Expense</h2>
                </div>
                
                <form id="expense-form">
                    <div class="form-group">
                        <label for="program-select">Select Program</label>
                        <select id="program-select" required>
                            <option value="">-- Select a Program --</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="expense-amount">Expense Amount ($)</label>
                        <input type="number" id="expense-amount" placeholder="Enter expense amount" min="0" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="expense-category">Category</label>
                        <select id="expense-category" required>
                            <option value="">-- Select Category --</option>
                            <option value="supplies">Supplies & Materials</option>
                            <option value="venue">Venue/Rental</option>
                            <option value="food">Food & Catering</option>
                            <option value="transportation">Transportation</option>
                            <option value="speakers">Speaker Fees</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="expense-description">Description</label>
                        <textarea id="expense-description" rows="2" placeholder="Brief description of the expense"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Upload Receipt/Bill</label>
                        <div class="upload-area" id="upload-area">
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <p>Click to upload receipt or drag and drop</p>
                            <p class="small">(JPG, PNG up to 5MB)</p>
                            <input type="file" id="bill-upload" class="file-input" accept=".jpg,.jpeg,.png">
                            <div class="file-name" id="file-name">No file selected</div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-secondary"><i class="fas fa-save"></i> Record Expense</button>
                </form>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <h2 class="card-title">Recent Expenses</h2>
                </div>
                
                <div class="expenses-list" id="expenses-list">
                    <!-- Expenses will be added here dynamically -->
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="reports-tab">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-line"></i>
                    <h2 class="card-title">Financial Overview</h2>
                </div>
                
                <div style="height: 300px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px;">
                    <p style="color: #7f8c8d; text-align: center;">
                        <i class="fas fa-chart-pie" style="font-size: 3rem; margin-bottom: 15px;"></i><br>
                        Financial reports visualization will appear here<br>
                        <small>Monthly income/expense trends and program spending analysis</small>
                    </p>
                </div>
                
                <div style="display: flex; justify-content: space-around; margin-top: 30px; flex-wrap: wrap; gap: 15px;">
                    <button class="btn-secondary" id="export-btn">
                        <i class="fas fa-file-export"></i> Export Data
                    </button>
                    <button id="sync-btn">
                        <i class="fas fa-sync"></i> Sync Data
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Bill Viewer Modal -->
        <div class="modal" id="bill-modal">
            <div class="modal-content">
                <span class="close-modal" id="close-modal">&times;</span>
                <img src="" alt="Bill Image" class="bill-image" id="bill-image">
            </div>
        </div>
        
        <div class="notification" id="notification">
            <i class="fas fa-check-circle"></i> <span id="notification-text">Notification message</span>
        </div>
        
        <footer>
            <p>Christ Life Community (CLC) Treasurer Dashboard | "Each of you should give what you have decided in your heart to give, not reluctantly or under compulsion, for God loves a cheerful giver." - 2 Corinthians 9:7</p>
            <p>© 2023 CLC Financial Ministry. All rights reserved.</p>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

    <script>
        // Firebase configuration (using a shared demo project)
        const firebaseConfig = {
            apiKey: "AIzaSyB5mN2LNHaaZZrQxjYDz2vK0PvR7bDcC5E",
            authDomain: "clc-treasurer-demo.firebaseapp.com",
            projectId: "clc-treasurer-demo",
            storageBucket: "clc-treasurer-demo.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890abcdef"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Global state
        let bankBalance = 60000;
        let cashBalance = 10000;
        let totalBalance = bankBalance + cashBalance;
        let programs = [];
        let expenses = [];
        let selectedBillFile = null;
        
        // DOM Elements
        const bankBalanceEl = document.getElementById('bank-balance');
        const cashBalanceEl = document.getElementById('cash-balance');
        const totalBalanceEl = document.getElementById('total-balance');
        const programForm = document.getElementById('program-form');
        const expenseForm = document.getElementById('expense-form');
        const programsTableBody = document.getElementById('programs-tbody');
        const programSelect = document.getElementById('program-select');
        const expensesList = document.getElementById('expenses-list');
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('bill-upload');
        const fileNameDisplay = document.getElementById('file-name');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');
        const exportBtn = document.getElementById('export-btn');
        const syncBtn = document.getElementById('sync-btn');
        const bankUpdateTime = document.getElementById('bank-update-time');
        const cashUpdateTime = document.getElementById('cash-update-time');
        const billModal = document.getElementById('bill-modal');
        const billImage = document.getElementById('bill-image');
        const closeModal = document.getElementById('close-modal');
        
        // Format currency
        function formatCurrency(amount) {
            return '$' + amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }
        
        // Show notification
        function showNotification(message, isError = false) {
            notificationText.textContent = message;
            notification.style.background = isError ? '#e74c3c' : '#27ae60';
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Update timestamps
        function updateTimestamps() {
            const now = new Date().toLocaleString();
            bankUpdateTime.textContent = now;
            cashUpdateTime.textContent = now;
        }
        
        // Update balance displays
        function updateBalances() {
            bankBalanceEl.textContent = formatCurrency(bankBalance);
            cashBalanceEl.textContent = formatCurrency(cashBalance);
            totalBalanceEl.textContent = formatCurrency(totalBalance);
            updateTimestamps();
        }
        
        // Save data to Firestore
        async function saveData() {
            try {
                const data = {
                    bankBalance,
                    cashBalance,
                    totalBalance,
                    programs,
                    expenses,
                    lastSaved: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection("treasurer").doc("data").set(data);
                showNotification('Data saved to cloud storage!');
            } catch (error) {
                console.error("Error saving data: ", error);
                showNotification('Error saving data: ' + error.message, true);
            }
        }
        
        // Load data from Firestore
        async function loadData() {
            try {
                const doc = await db.collection("treasurer").doc("data").get();
                if (doc.exists) {
                    const data = doc.data();
                    bankBalance = data.bankBalance || 60000;
                    cashBalance = data.cashBalance || 10000;
                    totalBalance = data.totalBalance || 70000;
                    programs = data.programs || [];
                    expenses = data.expenses || [];
                    
                    updateBalances();
                    renderPrograms();
                    renderExpenses();
                    showNotification('Data loaded from cloud storage');
                } else {
                    // Initialize with sample data if no data exists
                    initializeSampleData();
                }
            } catch (error) {
                console.error("Error loading data: ", error);
                showNotification('Error loading data: ' + error.message, true);
            }
        }
        
        // Initialize with sample data
        function initializeSampleData() {
            programs = [{
                id: Date.now() - 1000,
                name: "Christmas Star Project",
                date: "2023-12-20T18:00",
                budget: 5000,
                description: "• Buy glue\n• Purchase flex sheets\n• Iron rods for structure\n• LED lights\n• Mounting hardware",
                expenses: [],
                completed: false
            }];
            
            updateBalances();
            renderPrograms();
            showNotification('Initialized with sample data');
        }
        
        // Upload bill image to Firebase Storage
        async function uploadBillImage(file, expenseId) {
            if (!file) return null;
            
            try {
                const storageRef = storage.ref();
                const billRef = storageRef.child(`bills/${expenseId}_${file.name}`);
                await billRef.put(file);
                const downloadURL = await billRef.getDownloadURL();
                return downloadURL;
            } catch (error) {
                console.error("Error uploading bill: ", error);
                showNotification('Error uploading bill: ' + error.message, true);
                return null;
            }
        }
        
        // Render programs table
        function renderPrograms() {
            programsTableBody.innerHTML = '';
            programSelect.innerHTML = '<option value="">-- Select a Program --</option>';
            
            programs.forEach((program, index) => {
                // Calculate remaining budget
                const spent = program.expenses.reduce((sum, exp) => sum + exp.amount, 0);
                const remaining = program.budget - spent;
                
                // Determine status
                let statusClass = 'status-active';
                let statusText = 'Active';
                if (program.completed) {
                    statusClass = 'status-completed';
                    statusText = 'Completed';
                } else if (remaining < 0) {
                    statusClass = 'status-over-budget';
                    statusText = 'Over Budget';
                } else if (remaining < program.budget * 0.2) {
                    statusClass = 'status-warning';
                    statusText = 'Warning';
                }
                
                // Parse description into bullet points
                const descriptionPoints = program.description.split('\n')
                    .filter(line => line.trim() !== '')
                    .map(line => line.replace(/^\s*[\u2022\-]\s*/, '').trim());
                
                // Add to programs table
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div><strong>${program.name}</strong></div>
                        ${descriptionPoints.length > 0 ? `
                        <div class="program-details">
                            <h4>Description Items:</h4>
                            <ul class="description-points">
                                ${descriptionPoints.map(point => `<li>${point}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                    </td>
                    <td>${new Date(program.date).toLocaleString()}</td>
                    <td>${formatCurrency(program.budget)}</td>
                    <td>${formatCurrency(spent)}</td>
                    <td>${formatCurrency(remaining)}</td>
                    <td><span class="status-indicator ${statusClass}">${statusText}</span></td>
                    <td>
                        ${program.completed ? '' : `<button class="mark-complete-btn" data-index="${index}"><i class="fas fa-check"></i></button>`}
                        <button class="delete-btn" data-index="${index}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                programsTableBody.appendChild(row);
                
                // Add to expense form dropdown only if not completed
                if (!program.completed) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = program.name;
                    programSelect.appendChild(option);
                }
            });
            
            // Add event listeners to mark complete buttons
            document.querySelectorAll('.mark-complete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    markProgramComplete(index);
                });
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteProgram(index);
                });
            });
        }
        
        // Render expenses list
        function renderExpenses() {
            expensesList.innerHTML = '';
            
            // Sort expenses by date (newest first)
            const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedExpenses.forEach(expense => {
                const program = programs.find(p => p.id === expense.programId);
                const programName = program ? program.name : 'Unknown Program';
                
                const expenseItem = document.createElement('div');
                expenseItem.className = 'expense-item';
                expenseItem.innerHTML = `
                    <div class="expense-details">
                        <div><strong>${expense.description || 'Unnamed Expense'}</strong></div>
                        <div>${expense.category} • ${programName} • ${new Date(expense.date).toLocaleDateString()}</div>
                        ${expense.billUrl ? `<img src="${expense.billUrl}" alt="Bill Preview" class="bill-preview" data-url="${expense.billUrl}">` : '<div class="no-bill">No bill uploaded</div>'}
                    </div>
                    <div class="expense-amount">${formatCurrency(expense.amount)}</div>
                    <div>
                        ${expense.billUrl ? `<button class="view-bill-btn" data-url="${expense.billUrl}"><i class="fas fa-eye"></i> View</button>` : 'No Bill'}
                    </div>
                `;
                expensesList.appendChild(expenseItem);
            });
            
            // Add event listeners to bill previews and view buttons
            document.querySelectorAll('.bill-preview, .view-bill-btn').forEach(element => {
                element.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const url = this.getAttribute('data-url');
                    if (url) {
                        openBillModal(url);
                    }
                });
            });
        }
        
        // Open bill modal
        function openBillModal(imageUrl) {
            billImage.src = imageUrl;
            billModal.style.display = 'flex';
        }
        
        // Close bill modal
        function closeBillModal() {
            billModal.style.display = 'none';
        }
        
        // Mark a program as complete
        function markProgramComplete(index) {
            if (confirm('Mark this program as completed?\nUnused budget will be returned to cash on hand.')) {
                const program = programs[index];
                const spent = program.expenses.reduce((sum, exp) => sum + exp.amount, 0);
                const remaining = program.budget - spent;
                
                // Return unused budget to cash on hand
                if (remaining > 0) {
                    cashBalance += remaining;
                    totalBalance = bankBalance + cashBalance;
                    updateBalances();
                    
                    showNotification(`$${remaining.toFixed(2)} returned to cash on hand from "${program.name}"`);
                }
                
                program.completed = true;
                renderPrograms();
                saveData();
                showNotification(`Program "${program.name}" marked as completed!`);
            }
        }
        
        // Delete a program
        function deleteProgram(index) {
            if (confirm('Are you sure you want to delete this program? All associated expenses will also be deleted.')) {
                const program = programs[index];
                
                // Return full budget to cash on hand when deleting
                cashBalance += program.budget;
                totalBalance = bankBalance + cashBalance;
                updateBalances();
                
                // Remove program and its expenses
                const programId = program.id;
                programs.splice(index, 1);
                expenses = expenses.filter(expense => expense.programId !== programId);
                
                // Re-render
                renderPrograms();
                renderExpenses();
                saveData();
                
                showNotification(`Program "${program.name}" deleted and budget returned!`);
            }
        }
        
        // Handle program form submission
        programForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('program-name').value;
            const date = document.getElementById('program-date').value;
            const budget = parseFloat(document.getElementById('budget-amount').value);
            const description = document.getElementById('program-description').value;
            
            // Deduct budget from cash balance
            if (budget > cashBalance) {
                alert('Insufficient cash funds for this program budget!');
                return;
            }
            
            cashBalance -= budget;
            totalBalance = bankBalance + cashBalance;
            updateBalances();
            
            // Create program object
            const program = {
                id: Date.now(), // Unique ID
                name,
                date,
                budget,
                description,
                expenses: [],
                completed: false
            };
            
            programs.push(program);
            
            // Re-render programs
            renderPrograms();
            saveData();
            
            // Reset form
            programForm.reset();
            
            // Set current date/time
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('program-date').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            showNotification(`Program "${name}" created with $${budget.toFixed(2)} budget!`);
        });
        
        // Handle expense form submission
        expenseForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const programIndex = parseInt(document.getElementById('program-select').value);
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const category = document.getElementById('expense-category').value;
            const description = document.getElementById('expense-description').value;
            
            if (isNaN(programIndex)) {
                alert('Please select a program');
                return;
            }
            
            const program = programs[programIndex];
            
            // Upload bill image if selected
            let billUrl = null;
            if (selectedBillFile) {
                const expenseId = Date.now();
                billUrl = await uploadBillImage(selectedBillFile, expenseId);
            }
            
            // Add expense to program
            const expense = {
                id: Date.now(),
                programId: program.id,
                amount,
                category,
                description,
                date: new Date().toISOString(),
                billUrl: billUrl
            };
            
            program.expenses.push(expense);
            expenses.push(expense);
            
            // Re-render
            renderPrograms();
            renderExpenses();
            saveData();
            
            // Reset form
            expenseForm.reset();
            fileNameDisplay.textContent = 'No file selected';
            selectedBillFile = null;
            
            showNotification(`Expense of $${amount.toFixed(2)} recorded for "${program.name}"!`);
        });
        
        // File upload handling
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                selectedBillFile = fileInput.files[0];
                fileNameDisplay.textContent = selectedBillFile.name;
            } else {
                fileNameDisplay.textContent = 'No file selected';
                selectedBillFile = null;
            }
        });
        
        // Tab switching functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and content
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Show corresponding content
                const tabId = tab.getAttribute('data-tab') + '-tab';
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // Export data to JSON
        exportBtn.addEventListener('click', () => {
            const dataStr = JSON.stringify({
                bankBalance,
                cashBalance,
                totalBalance,
                programs,
                expenses,
                exportedAt: new Date().toISOString()
            }, null, 2);
            
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `clc_treasurer_data_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Data exported successfully!');
        });
        
        // Manual sync
        syncBtn.addEventListener('click', () => {
            saveData();
        });
        
        // Close modal when clicking close button or outside the modal
        closeModal.addEventListener('click', closeBillModal);
        billModal.addEventListener('click', function(e) {
            if (e.target === billModal) {
                closeBillModal();
            }
        });
        
        // Initialize with current date/time
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const formattedDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
        document.getElementById('program-date').value = formattedDateTime;
        
        // Initial load
        loadData();
        
        // Update balances initially
        updateBalances();
    </script>
</body>
</html>