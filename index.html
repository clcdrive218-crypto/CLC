<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLC Treasurer Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%); color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; padding: 20px; background: linear-gradient(to right, #2c3e50, #4a6491); color: white; border-radius: 10px; margin-bottom: 30px; }
        h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .card { background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); padding: 25px; margin-bottom: 25px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        input, select, textarea, button { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }
        button { background: linear-gradient(to right, #3498db, #2c3e50); color: white; border: none; cursor: pointer; font-weight: 600; margin-top: 10px; }
        .balance-display { text-align: center; padding: 20px; }
        .balance-amount { font-size: 2rem; font-weight: 700; color: #2c3e50; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px; border-radius: 8px; background: #27ae60; color: white; z-index: 1000; transform: translateX(200%); transition: transform 0.3s ease; }
        .notification.show { transform: translateX(0); }
        .github-info { background: #f0f0f0; border-left: 4px solid #333; padding: 15px; border-radius: 0 6px 6px 0; margin: 20px 0; }
        .token-input { display: flex; gap: 10px; margin-top: 15px; }
        .token-input input { flex-grow: 1; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-church"></i> CLC Treasurer Dashboard</h1>
            <p>GitHub Gist Storage Edition</p>
        </header>
        
        <div class="card">
            <h2><i class="fab fa-github"></i> GitHub Authorization</h2>
            <p>Enter your GitHub token to enable data storage:</p>
            
            <div class="token-input">
                <input type="password" id="github-token" placeholder="Enter GitHub Token">
                <button id="save-token-btn"><i class="fas fa-save"></i> Save</button>
            </div>
            
            <div class="token-input" style="margin-top: 10px;">
                <input type="text" id="gist-id" placeholder="Enter Gist ID (optional)">
                <button id="load-gist-btn"><i class="fas fa-download"></i> Load Data</button>
            </div>
        </div>
        
        <div class="github-info">
            <p><i class="fas fa-info-circle"></i> All data is stored in your GitHub Gists. No local browser storage is used.</p>
            <p>Gist ID: <strong id="current-gist-id">Not yet created</strong></p>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-calculator"></i> Financial Summary</h2>
            <div class="balance-display">
                <div>Bank Balance: <span class="balance-amount" id="bank-balance">$60,000.00</span></div>
                <div>Cash on Hand: <span class="balance-amount" id="cash-balance">$10,000.00</span></div>
                <div>Total Funds: <span class="balance-amount" id="total-balance">$70,000.00</span></div>
                <button id="save-to-gist-btn"><i class="fab fa-github"></i> Save to GitHub Gist</button>
            </div>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-calendar-plus"></i> Create New Program</h2>
            <form id="program-form">
                <div class="form-group">
                    <label for="program-name">Program Name</label>
                    <input type="text" id="program-name" placeholder="Enter program name" required>
                </div>
                
                <div class="form-group">
                    <label for="budget-amount">Budget Amount ($)</label>
                    <input type="number" id="budget-amount" placeholder="Enter budget amount" min="0" step="0.01" required>
                </div>
                
                <button type="submit"><i class="fas fa-plus-circle"></i> Create Program</button>
            </form>
        </div>
        
        <div class="notification" id="notification">
            <i class="fas fa-check-circle"></i> <span id="notification-text">Notification message</span>
        </div>
    </div>

    <script>
        // Global state
        let bankBalance = 60000;
        let cashBalance = 10000;
        let totalBalance = bankBalance + cashBalance;
        let programs = [];
        let githubToken = '';
        let gistId = '';
        
        // DOM Elements
        const bankBalanceEl = document.getElementById('bank-balance');
        const cashBalanceEl = document.getElementById('cash-balance');
        const totalBalanceEl = document.getElementById('total-balance');
        const programForm = document.getElementById('program-form');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');
        const githubTokenInput = document.getElementById('github-token');
        const gistIdInput = document.getElementById('gist-id');
        const saveTokenBtn = document.getElementById('save-token-btn');
        const loadGistBtn = document.getElementById('load-gist-btn');
        const currentGistIdEl = document.getElementById('current-gist-id');
        const saveToGistBtn = document.getElementById('save-to-gist-btn');
        
        // Format currency
        function formatCurrency(amount) {
            return '$' + amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }
        
        // Show notification
        function showNotification(message, isError = false) {
            notificationText.textContent = message;
            notification.style.background = isError ? '#e74c3c' : '#27ae60';
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Update balance displays
        function updateBalances() {
            bankBalanceEl.textContent = formatCurrency(bankBalance);
            cashBalanceEl.textContent = formatCurrency(cashBalance);
            totalBalanceEl.textContent = formatCurrency(totalBalance);
        }
        
        // Save data to GitHub Gist
        async function saveToGist() {
            if (!githubToken) {
                showNotification('Please enter your GitHub token first!', true);
                return;
            }
            
            const data = {
                bankBalance,
                cashBalance,
                totalBalance,
                programs,
                lastSaved: new Date().toISOString()
            };
            
            const filename = `clc_treasurer_data_${new Date().toISOString().slice(0,10)}.json`;
            
            try {
                const gistData = {
                    description: "CLC Treasurer Dashboard Data",
                    public: false,
                    files: {}
                };
                
                if (gistId) {
                    // Update existing gist
                    gistData.files[filename] = {
                        content: JSON.stringify(data, null, 2)
                    };
                    
                    const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(gistData)
                    });
                    
                    if (!response.ok) throw new Error('Failed to update gist');
                } else {
                    // Create new gist
                    gistData.files[filename] = {
                        content: JSON.stringify(data, null, 2)
                    };
                    
                    const response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(gistData)
                    });
                    
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);
                    
                    gistId = result.id;
                    currentGistIdEl.textContent = gistId;
                }
                
                showNotification('Data saved to GitHub Gist!');
                return true;
            } catch (error) {
                console.error('Save error:', error);
                showNotification(`Save failed: ${error.message}`, true);
                return false;
            }
        }
        
        // Load data from GitHub Gist
        async function loadFromGist(id) {
            if (!githubToken) {
                showNotification('Please enter your GitHub token first!', true);
                return;
            }
            
            const targetGistId = id || gistId;
            if (!targetGistId) {
                showNotification('Please enter a Gist ID to load data', true);
                return;
            }
            
            try {
                const response = await fetch(`https://api.github.com/gists/${targetGistId}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load gist');
                }
                
                const gist = await response.json();
                
                // Find the first JSON file
                let jsonData = null;
                for (const filename in gist.files) {
                    if (filename.endsWith('.json')) {
                        jsonData = JSON.parse(gist.files[filename].content);
                        break;
                    }
                }
                
                if (!jsonData) {
                    throw new Error('No JSON data found in gist');
                }
                
                // Update global state
                bankBalance = jsonData.bankBalance || 60000;
                cashBalance = jsonData.cashBalance || 10000;
                totalBalance = jsonData.totalBalance || 70000;
                programs = jsonData.programs || [];
                gistId = targetGistId;
                currentGistIdEl.textContent = gistId;
                
                // Update UI
                updateBalances();
                showNotification('Data loaded from GitHub Gist!');
                return true;
            } catch (error) {
                console.error('Load error:', error);
                showNotification(`Load failed: ${error.message}`, true);
                return false;
            }
        }
        
        // Handle program form submission
        programForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('program-name').value;
            const budget = parseFloat(document.getElementById('budget-amount').value);
            
            // Deduct budget from cash balance
            if (budget > cashBalance) {
                alert('Insufficient cash funds for this program budget!');
                return;
            }
            
            cashBalance -= budget;
            totalBalance = bankBalance + cashBalance;
            updateBalances();
            
            // Create program object
            const program = {
                id: Date.now(),
                name,
                budget,
                date: new Date().toISOString()
            };
            
            programs.push(program);
            
            // Reset form
            programForm.reset();
            
            showNotification(`Program "${name}" created with $${budget.toFixed(2)} budget!`);
            
            // Auto-save to GitHub
            saveToGist();
        });
        
        // Save GitHub token
        saveTokenBtn.addEventListener('click', () => {
            githubToken = githubTokenInput.value.trim();
            if (githubToken) {
                showNotification('GitHub token saved!');
            } else {
                showNotification('Please enter a valid token', true);
            }
        });
        
        // Load from Gist
        loadGistBtn.addEventListener('click', () => {
            const id = gistIdInput.value.trim();
            if (id) {
                loadFromGist(id);
            } else {
                showNotification('Please enter a Gist ID', true);
            }
        });
        
        // Save to GitHub Gist
        saveToGistBtn.addEventListener('click', saveToGist);
        
        // Initial balance update
        updateBalances();
    </script>
</body>
</html>